# 📧 メール機能設定ガイド

## 📋 概要

CusHara Sentinelには以下のメール機能が実装されています：

### 実装済みの自動メール

1. **歓迎メール** - 新規アカウント作成時に自動送信
   - ✅ HTMLテンプレート作成済み
   - ✅ 日本語対応
   - ✅ システム機能の紹介
   - ✅ ダッシュボードへのリンク

### 今後追加可能な機能

- 事案報告時の確認メール
- 事案ステータス変更通知
- 定期レポートの送信
- パスワードリセットメール（Supabaseデフォルト）

---

## 🚀 メール機能を有効化する手順

### ステップ1: Resendアカウントの作成

Resendは無料で月3,000通まで送信できるメールサービスです。

1. https://resend.com にアクセス
2. 「Sign Up」をクリック
3. メールアドレスでアカウント作成
4. メール認証を完了

---

### ステップ2: Resend APIキーの取得

1. Resendダッシュボードにログイン
2. 左サイドバーの「**API Keys**」をクリック
3. 「**Create API Key**」をクリック
4. 名前を入力：`cushara-sentinel-production`
5. Permission: **Full access** を選択
6. 「**Add**」をクリック
7. 表示されたAPIキーをコピー（例: `re_xxxxxxxxxxxxx`）
   - ⚠️ **重要**: このキーは一度しか表示されません！

---

### ステップ3: ドメイン認証（推奨）

独自ドメインからメールを送信する場合（例: `noreply@ei-life.co.jp`）：

1. Resendダッシュボードで「**Domains**」をクリック
2. 「**Add Domain**」をクリック
3. ドメイン名を入力：`ei-life.co.jp`
4. 表示されるDNSレコードをドメインのDNS設定に追加：
   ```
   Type: TXT
   Name: _resend
   Value: （表示された値）
   ```
5. 認証完了を待つ（数分〜数時間）

**ドメイン認証しない場合**:
- デフォルトの `noreply@resend.dev` から送信されます
- 月100通まで無料

---

### ステップ4: Supabaseに環境変数を設定

1. https://supabase.com/dashboard にアクセス
2. プロジェクトを選択
3. 左サイドバーの「**Project Settings**」をクリック
4. 「**Edge Functions**」セクションを開く
5. 「**Add new secret**」をクリック
6. 以下を入力：
   ```
   Name: RESEND_API_KEY
   Value: （コピーしたAPIキー）
   ```
7. 「**Save**」をクリック

---

### ステップ5: Supabase Functionsをデプロイ

#### 方法A: Supabase CLIを使用（推奨）

1. Supabase CLIをインストール（まだの場合）：
   ```powershell
   npm install -g supabase
   ```

2. Supabaseにログイン：
   ```powershell
   supabase login
   ```

3. プロジェクトにリンク：
   ```powershell
   supabase link --project-ref hoddkegcbotyjrdoauio
   ```

4. Functionsをデプロイ：
   ```powershell
   supabase functions deploy send-welcome-email
   ```

#### 方法B: Supabaseダッシュボードから手動デプロイ

1. Supabaseダッシュボードで「**Edge Functions**」を開く
2. 「**Create a new function**」をクリック
3. 名前：`send-welcome-email`
4. `supabase/functions/send-welcome-email/index.ts` の内容をコピー&ペースト
5. 「**Deploy function**」をクリック

---

### ステップ6: 送信元アドレスの変更（任意）

デフォルトの送信元を変更する場合：

1. `supabase/functions/send-welcome-email/index.ts` を開く
2. 141行目を編集：
   ```typescript
   // 変更前
   from: 'CusHara Sentinel <noreply@resend.dev>',
   
   // 変更後（独自ドメイン認証済みの場合）
   from: 'CusHara Sentinel <noreply@ei-life.co.jp>',
   ```
3. ファイルを保存
4. 再デプロイ：
   ```powershell
   supabase functions deploy send-welcome-email
   ```

---

### ステップ7: テスト送信

#### テストユーザーを作成してメールを確認

1. http://localhost:8083 または本番環境にアクセス
2. 「アカウント作成」をクリック
3. テスト用のメールアドレスを入力
4. アカウント作成完了
5. メールボックスを確認

✅ 成功すると、以下のメールが届きます：
- 件名：「🛡️ CusHara Sentinelへようこそ！アカウント作成完了のお知らせ」
- 美しいHTMLメール
- ダッシュボードへのリンク

---

## 📊 メールテンプレートのカスタマイズ

メールの内容を変更したい場合：

1. `supabase/functions/send-welcome-email/index.ts` を開く
2. `generateWelcomeEmailHTML` 関数（14行目〜）を編集
3. HTMLとCSSを自由にカスタマイズ
4. 保存して再デプロイ

### カスタマイズ例

```typescript
// 会社名を変更
<strong>CusHara Sentinel</strong><br>
↓
<strong>株式会社EI-Life カスハラ対策チーム</strong><br>

// サポートメールアドレスを変更
<a href="mailto:support@cushara-sentinel.jp">
↓
<a href="mailto:support@ei-life.co.jp">

// 会社のロゴを追加
<img src="https://your-domain.com/logo.png" alt="Logo" style="height: 50px;">
```

---

## 🔔 追加のメール通知を実装する

### 事案報告時の確認メール

新しいEdge Functionを作成：

1. `supabase/functions/send-incident-notification/index.ts` を作成
2. 以下の内容：

```typescript
import { serve } from "https://deno.land/std@0.168.0/http/server.ts";

serve(async (req) => {
  try {
    const { userEmail, incidentTitle, incidentId } = await req.json();

    const html = `
      <!DOCTYPE html>
      <html lang="ja">
      <body>
        <h1>事案報告を受け付けました</h1>
        <p>以下の事案が正常に登録されました：</p>
        <ul>
          <li>事案ID: ${incidentId}</li>
          <li>タイトル: ${incidentTitle}</li>
        </ul>
        <p>ダッシュボードで詳細を確認できます。</p>
      </body>
      </html>
    `;

    const resendApiKey = Deno.env.get('RESEND_API_KEY');
    
    await fetch('https://api.resend.com/emails', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${resendApiKey}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        from: 'CusHara Sentinel <noreply@ei-life.co.jp>',
        to: [userEmail],
        subject: '事案報告を受け付けました',
        html,
      }),
    });

    return new Response(JSON.stringify({ success: true }), {
      headers: { 'Content-Type': 'application/json' },
    });
  } catch (error) {
    return new Response(JSON.stringify({ error: error.message }), {
      status: 500,
      headers: { 'Content-Type': 'application/json' },
    });
  }
});
```

3. デプロイ：
   ```powershell
   supabase functions deploy send-incident-notification
   ```

---

## 📈 メール送信の監視

### Resendダッシュボードで確認

1. https://resend.com/emails にアクセス
2. 送信履歴を確認：
   - 送信成功/失敗
   - 開封率（オプション）
   - クリック率（オプション）
   - バウンス率

### Supabase Logsで確認

1. Supabaseダッシュボード → **Edge Functions** → **Logs**
2. `send-welcome-email` のログを確認
3. エラーがあれば詳細を確認

---

## 🎯 無料プランの制限

### Resend 無料プラン

- 月3,000通まで
- 1日100通まで（ドメイン未認証の場合）
- ドメイン認証後は制限なし

### 有料プランにアップグレード

月$20で50,000通まで送信可能

---

## ✅ チェックリスト

- [ ] Resendアカウント作成
- [ ] Resend APIキー取得
- [ ] （任意）ドメイン認証
- [ ] Supabaseに環境変数設定（RESEND_API_KEY）
- [ ] Supabase Functionsデプロイ
- [ ] 送信元アドレス変更（任意）
- [ ] テスト送信で動作確認
- [ ] メールテンプレートカスタマイズ（任意）

---

## 🆘 トラブルシューティング

### メールが届かない

1. **Resend APIキーが正しいか確認**
   - Supabase Project Settings → Edge Functions → Secrets
   
2. **Functionsが正常にデプロイされているか確認**
   - Supabase Edge Functions → send-welcome-email
   
3. **ログを確認**
   - Edge Functions → Logs
   
4. **スパムフォルダを確認**

### エラー: "RESEND_API_KEY が設定されていません"

Supabaseの環境変数が設定されていません。ステップ4を確認してください。

### エラー: "403 Forbidden"

Resend APIキーが無効または期限切れです。新しいキーを生成してください。

---

設定が完了したらお知らせください！

